<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Heroicons for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.0.16/solid.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #E0F7FA 0%, #B2EBF2 100%);
            color: #374151;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .portal-card {
            max-width: 450px;
            padding: 2rem;
            border-radius: 12px;
            background: white;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
            animation: fadeInUp 0.6s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .input-field:focus {
            border-color: #4B9CD3;
            box-shadow: 0 0 0 3px rgba(75, 156, 211, 0.2);
            outline: none;
        }
        .btn-reset {
            background: linear-gradient(90deg, #4B9CD3, #6BA4D4);
            transition: all 0.3s ease;
        }
        .btn-reset:hover {
            background: linear-gradient(90deg, #3A8AC2, #5A93C3);
            transform: translateY(-2px);
        }
        .message-success {
            animation: slideIn 0.5s ease-out;
        }
        .message-error {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* âœ… Strength meter style */
        .strength-meter {
            height: 6px;
            border-radius: 4px;
            background: #e5e7eb; /* Tailwind gray-200 default */
            transition: width 0.3s ease, background-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="portal-card">
        <div class="text-center mb-6">
            <i class="h-12 w-12 text-blue-500 mx-auto mb-2" data-icon="lock-closed"></i>
            <h1 class="text-2xl font-bold text-gray-800">Password Reset Portal</h1>
            <p class="text-sm text-gray-500">Reset your VM password securely and easily</p>
        </div>
        <form id="resetForm" class="space-y-4" onsubmit="event.preventDefault(); resetPassword();">
            <div>
                <label for="vm_ip" class="block text-sm font-medium text-gray-700">VM IP Address</label>
                <input type="text" id="vm_ip" name="vm_ip" class="input-field mt-1 p-2 w-full border border-gray-300 rounded-md" placeholder="e.g., 192.168.91.129" required pattern="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}" title="Enter a valid IP (e.g., 192.168.1.1)">
            </div>
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                <input type="text" id="username" name="username" class="input-field mt-1 p-2 w-full border border-gray-300 rounded-md" placeholder="e.g., user1" required>
            </div>
            <div>
                <label for="old_password" class="block text-sm font-medium text-gray-700">Old Password</label>
                <input type="password" id="old_password" name="old_password" class="input-field mt-1 p-2 w-full border border-gray-300 rounded-md" placeholder="Enter old password" required>
            </div>
            <div>
                <label for="new_password" class="block text-sm font-medium text-gray-700">New Password (min 8 chars)</label>
                <input type="password" id="new_password" name="new_password" class="input-field mt-1 p-2 w-full border border-gray-300 rounded-md" placeholder="Enter new password" required oninput="checkPasswordStrength()">
                <div id="strength-meter" class="strength-meter mt-1"></div>
            </div>
            <button type="button" onclick="resetPassword()" class="btn-reset w-full text-white p-2 rounded-md font-semibold">Reset My Password</button>
            <div id="message" class="message-success text-green-700 text-center mt-4 hidden"></div>
            <div id="error" class="message-error text-red-700 text-center mt-4 hidden"></div>
        </form>
    </div>
    <script>
        // âœ… Enhanced password strength checker (matches backend rules)
        function checkPasswordStrength() {
            const password = document.getElementById('new_password').value;
            const meter = document.getElementById('strength-meter');
            const errorDiv = document.getElementById('error');

            let errors = [];
        // Password policy checks    
            if (password.length < 8) errors.push("At least 8 characters");
            if (!/[A-Z]/.test(password)) errors.push("One uppercase letter");
            if (!/[a-z]/.test(password)) errors.push("One lowercase letter");
            if (!/[0-9]/.test(password)) errors.push("One number");
            if (!/[!@#$%^&*(),.?\":{}|<>]/.test(password)) errors.push("One special character");
        // Calculate progress for strength bar    
            const satisfied = 5 - errors.length;
            const percent = (satisfied / 5) * 100;

            meter.style.width = percent + '%';
            if (percent < 40) {
                meter.className = 'strength-meter mt-1 bg-red-500';
            } else if (percent < 80) {
                meter.className = 'strength-meter mt-1 bg-yellow-500';
            } else {
                meter.className = 'strength-meter mt-1 bg-green-500';
            }

            // Optional: Show requirements if not satisfied
            if (errors.length > 0) {
                errorDiv.innerText = "Password needs: " + errors.join(", ");
                errorDiv.classList.remove('hidden');
            } else {
                errorDiv.classList.add('hidden');
            }
        }

        // function isValidIP(ip) {
        //     return /^(\d{1,3}\.){3}\d{1,3}$/.test(ip);
        // }

        // function resetPassword() {
        //     const vmIP = document.getElementById('vm_ip').value;
        //     const newPassword = document.getElementById('new_password').value;
        //     const errorDiv = document.getElementById('error');
        //     const messageDiv = document.getElementById('message');

        //     if (!isValidIP(vmIP)) {
        //         errorDiv.innerText = "Please enter a valid IPv4 address (e.g., 192.168.1.10).";
        //         errorDiv.classList.remove('hidden');
        //         messageDiv.classList.add('hidden');
        //         return;
        //     }

        //     if (newPassword.length < 8) {
        //         errorDiv.innerText = 'New password must be at least 8 characters!';
        //         errorDiv.classList.remove('hidden');
        //         messageDiv.classList.add('hidden');
        //         return;
        //     }

        //     const form = document.getElementById('resetForm');
        //     const formData = new FormData(form);
        //     fetch('/reset_password', {
        //         method: 'POST',
        //         body: formData
        //     })
        //     .then(response => response.json())
        //     .then(data => {
        //         if (data.message) {
        //             messageDiv.innerText = data.message;
        //             messageDiv.classList.remove('hidden');
        //             errorDiv.classList.add('hidden');
        //         } else {
        //             errorDiv.innerText = data.error || 'Old password incorrect or connection failed!';
        //             errorDiv.classList.remove('hidden');
        //             messageDiv.classList.add('hidden');
        //         }
        //     })
        //     .catch(error => {
        //         errorDiv.innerText = 'An error occurred. Please try again.';
        //         errorDiv.classList.remove('hidden');
        //         messageDiv.classList.add('hidden');
        //     });
        // }
           // ðŸ”¹ Call backend API to reset password
    function resetPassword() {
      const form = document.getElementById('resetForm');
      const formData = new FormData(form);
      const errorDiv = document.getElementById('error');
      const messageDiv = document.getElementById('message');

      fetch('/reset_password', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          // Success response
          messageDiv.innerText = data.message;
          messageDiv.classList.remove('hidden');
          errorDiv.classList.add('hidden');
           // âœ… Auto-hide after 5 seconds
            setTimeout(() => messageDiv.classList.add('hidden'), 7000);
        } else {
          // Error response
          errorDiv.innerText = data.error || 'Password reset failed.';
          errorDiv.classList.remove('hidden');
          messageDiv.classList.add('hidden');
            // âœ… Auto-hide after 5 seconds
              setTimeout(() => errorDiv.classList.add('hidden'), 7000);

        }
      })
      .catch(() => {
        // Network/backend error
        errorDiv.innerText = 'An error occurred. Please try again.';
        errorDiv.classList.remove('hidden');
        messageDiv.classList.add('hidden');
      });
    }
    </script>
</body>
</html>
